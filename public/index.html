<!DOCTYPE html>
<html data-theme="light" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor Tracker with Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        .cursor { position: absolute; width: 10px; height: 10px; background: red; border-radius: 50%; }
        .player-name { margin-bottom: 5px; }
        #join-form { display: flex; flex-direction: column; align-items: center; margin-top: 20px; }
        .chat { position: fixed; bottom: 10px; left: 10px; width: 300px; background: white; border: 1px solid black; padding: 10px; }
        .message { margin-bottom: 5px; }
    </style>
</head>
<body>
    <form id="join-form" enctype="multipart/form-data">
        <input type="text" class="input input-bordered input-primary w-full max-w-xs mb-2" id="room-input" placeholder="Room Name" />
        <input type="text" class="input input-bordered input-primary w-full max-w-xs mb-2" id="name-input" placeholder="Your Name" />
        <input type="file" class="file-input file-input-bordered w-full max-w-xs" id="avatar-input" name="avatar" accept="image/*" />
        <input type="color" id="color-picker" value="#ff0000">
        <button class="btn btn-primary mt-2" type="submit">Join Room</button>
    </form>
    <div class="player-list flex flex-col items-start fixed top-10 right-10 bg-white p-4 border border-black rounded-lg" id="player-list"></div>
    <div class="chat" id="chat" style="display:none;">
        <div class="messages h-[200px] overflow-y-scroll mb-10" id="messages"></div>
        <input type="text" id="message-input" placeholder="Type a message" />
        <button id="send-button">Send</button>
    </div>
    <script>
        let ws;
        let cursors = {};
        let name;
        let room;
        let selectedColor = '#ff0000';

        document.getElementById('join-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            room = document.getElementById('room-input').value;
            name = document.getElementById('name-input').value;
            selectedColor = document.getElementById('color-picker').value;

            const avatarInput = document.getElementById('avatar-input');
            let avatarUrl = '';

            if (avatarInput.files.length > 0) {
                const formData = new FormData();
                formData.append('avatar', avatarInput.files[0]);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    avatarUrl = data.url;
                }
            }

            if (room && name) {
                ws = new WebSocket(`wss://${window.location.host}`);
                ws.onopen = () => {
                    ws.send(JSON.stringify({ action: 'join', payload: { room, name, avatar: avatarUrl, color: selectedColor } }));
                    document.getElementById('join-form').style.display = 'none';
                    document.getElementById('chat').style.display = 'block';
                };

                ws.onmessage = (event) => {
                    const { action, payload } = JSON.parse(event.data);

                    switch (action) {
                        case 'updatePlayers':
                            updatePlayerList(payload);
                            break;
                        case 'move':
                            updateCursor(payload);
                            break;
                        case 'removeCursor':
                            removeCursor(payload);
                            break;
                        case 'chat':
                            addMessage(payload);
                            break;
                        default:
                            break;
                    }
                };

                document.addEventListener('mousemove', (e) => {
                    const data = { x: e.clientX, y: e.clientY };
                    ws.send(JSON.stringify({ action: 'move', payload: data }));
                });

                document.getElementById('message-input').addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        sendMessage();
                    }
                });

                document.getElementById('send-button').addEventListener('click', () => {
                    sendMessage();
                });

                function sendMessage() {
                    const message = document.getElementById('message-input').value;
                    if (message) {
                        ws.send(JSON.stringify({ action: 'chat', payload: { room, name, message } }));
                        document.getElementById('message-input').value = '';
                    }
                }
            }
        });

        function updatePlayerList(players) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            players.forEach(player => {
                const { name, avatar, color } = player;

                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-name flex flex-row-reverse items-center gap-2';
                playerDiv.textContent = name;
                playerDiv.style.color = color;

                const avatarDiv = document.createElement('div');
                avatarDiv.className = `ring-2 rounded-full ring-[${color}] size-[50px] bg-cover`;
                avatarDiv.style.backgroundImage = `url(${avatar})`;

                playerDiv.appendChild(avatarDiv);
                playerList.appendChild(playerDiv);
            });
        }

        function updateCursor({ name, x, y, avatar, color }) {
            if (!cursors[name]) {
                const cursor = document.createElement('div');
                cursor.classList.add('cursor');
                cursor.style.backgroundImage = `url(${avatar})`; // Use avatar image
                cursor.classList.add('bg-cover');
                cursor.classList.add('size-[50px]', 'ring-2', `ring-[${color}]`);

                const label = document.createElement('span');
                label.classList.add('label', 'relative', 'right-8');
                label.textContent = name;
                cursor.appendChild(label);
                document.body.appendChild(cursor);
                cursors[name] = cursor;
            }

            const cursor = cursors[name];
            cursor.style.left = `${x}px`;
            cursor.style.top = `${y}px`;
        }

        function removeCursor({ name }) {
            if (cursors[name]) {
                document.body.removeChild(cursors[name]);
                delete cursors[name];
            }
        }

        function addMessage({ date, name, message, color }) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.style.color = color; // Apply selected color
            messageDiv.innerHTML = `<span style="color:${color}"><strong>${name}</strong></span> [${date}]: ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>
